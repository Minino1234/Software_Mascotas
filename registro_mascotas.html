<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar Mascota</title>

  <!-- Estilos externos -->
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Nunito', sans-serif;
      background-color: #eef3f8;
    }

   .background {
  background-image: url('imagenes/catedralHuaraz.jpg'); /* Usa aqu√≠ tu imagen real */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  min-height: 100vh;
  padding-top: 160px; /* m√°s espacio para separar del navbar */
  position: relative;
}

    .navbar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.75);
      z-index: 1000;
      border-radius: 30px;
      padding: 14px 30px;
      width: 95%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .navbar-title {
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #000;
    }

    .navbar-title i {
      font-size: 1.2rem;
      color: #007bff;
    }

    .navbar-links {
      display: flex;
      gap: 25px;
    }

    .navbar-links a {
      text-decoration: none;
      color: #007bff;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .navbar-links a:hover {
      background-color: #007bff;
      color: white;
    }

    .boton-atras {
      position: absolute;
      top: 160px;
      left: 30px;
      background-color: #007bff;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
      z-index: 999;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .boton-atras:hover {
      background-color: #0056b3;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 40px;
      max-width: 1000px;
      margin: auto;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      animation: fadeInUp 0.6s;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
      margin-bottom: 6px;
      color: #003366;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    input:focus, select:focus {
      border-color: #007bff;
      outline: none;
    }

    .boton {
      margin-top: 25px;
      padding: 12px;
      background-color: #007bff;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .boton:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }

    #previewImagen {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin-top: 10px;
      display: none;
      border-radius: 8px;
    }

    .editar-btn {
      background-color: #ffc107;
      color: black;
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .eliminar-btn {
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <header class="navbar">
    <div class="navbar-title">
      <i class="fas fa-dog"></i> Municipalidad de Huaraz
    </div>
    <nav class="navbar-links">
      <a href="registro_personas.html">Registrar Propietario o Veterinario</a>
      <a href="registro_mascotas.html">Registro de Mascotas</a>
      <a href="interfaz_campa√±a.html">Registro de Campa√±as</a>
      <a href="registro_medicamentos.html">Registro de Medicamentos</a>
      <a href="registro_ficha.html">Registro de Ficha</a>
    </nav>
  </header>

  <div class="background">
    <a href="main_menu.html" class="boton-atras">‚Üê Volver al men√∫ principal</a>

    <div class="container animate__animated animate__fadeIn">
  <img src="imagenes/logo2muni.png" alt="Logo" style="width:450px; height:auto; margin: 0 auto 20px; display: block;" />
  <h2>Registrar Mascota</h2>
  <form id="formMascota" enctype="multipart/form-data">
     <input type="hidden" id="idMascota" name="idMascota" />
    <label>Nombre de la Mascota:</label>
    <input type="text" name="nombreMascota" id="nombreMascota" required maxlength="25" placeholder="Ingrese el nombre" />

    <label>Foto de la mascota:</label>
<input type="file" name="fotoMascota" id="fotoMascota" accept="image/*" />

<img id="previewImagen" src="" alt="Previsualizaci√≥n" style="width:100px; height:100px; object-fit:cover; margin-top:10px; display:none;" />

    <label>Especie:</label>
<select name="idEspecie" id="especieSelect" required>
  <option value="">Cargando...</option>
</select>

<label>G√©nero:</label>
<select name="idGenero" id="generoSelect" required>
  <option value="">Cargando...</option>
</select>

    <label>Edad (a√±os):</label>
    <input type="number" name="edad_mascotas" id="edadMascota" min="0" max="30" required />

    <label>Color:</label>
    <input type="text" name="color" id="colorMascota" maxlength="50" required />

    <label>Comportamiento:</label>
    <select name="idcomportamientos" id="comportamientoSelect" required></select>

    <label>DNI del Propietario:</label>
    <input type="text" name="dni_propietario" id="dniPropietario" maxlength="8" pattern="[0-9]{8}" placeholder="12345678" required />

    <p id="mensajePropietario" class="hidden" style="color: red;"></p>
    <h4>Propietario encontrado:</h4>
    <table id="tablaPropietario" border="1" style="width:100%; display:none;">
      <thead><tr><th>Apellidos y Nombres</th><th>DNI</th><th>Barrio</th></tr></thead>
      <tbody></tbody>
    </table>
    <button type="submit" id="btnGuardar" class="boton">Registrar Mascota</button>
  </form>

  <button class="boton" onclick="toggleRegistros()">Ver registros recientes</button>


  
  <div id="panelRegistros" style="display:none;">
    <h3>üêæ √öltimos 10 registros</h3>
    <input type="text" id="buscarMascotas" placeholder="Buscar por DNI, nombre del propietario o mascota
    " style="width:60%;" />
    <select id="ordenarMascotas">
      <option value="nombreMascota">üê∂ Nombre de Mascota</option>
      <option value="propietario">üë§ Apellidos y Nombre</option>
    </select>
    <div id="tablaMascotas" style="margin-top:20px;"></div>
  </div>
</div>

<script>
  cargarComportamientos();
  cargarEspecies();
  cargarGeneros();

$("#fotoMascota").on("change", function (e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (event) {
      $("#previewImagen").attr("src", event.target.result).show();
    };
    reader.readAsDataURL(file);
  }
});

function cargarEspecies() {
  $.get("logica_mascotas.php", { accion: "listar_especies" }, function (data) {
    const opciones = JSON.parse(data);
    $("#especieSelect").html('<option value="">Seleccione especie</option>');
    opciones.forEach(e => {
      $("#especieSelect").append(`<option value="${e.id}">${e.nombre}</option>`);
    });
  });
}

function cargarGeneros() {
  $.get("logica_mascotas.php", { accion: "listar_generos" }, function (data) {
    const opciones = JSON.parse(data);
    $("#generoSelect").html('<option value="">Seleccione g√©nero</option>');
    opciones.forEach(g => {
      $("#generoSelect").append(`<option value="${g.id}">${g.nombre}</option>`);
    });
  });
}
let modoEdicion = false;
let idMascotaEdicion = null;

function cargarComportamientos() {
  $.get("logica_mascotas.php", { accion: "listar_comportamientos" }, data => {
    const opciones = JSON.parse(data);
    $("#comportamientoSelect").html('<option value="">Seleccione</option>');
    opciones.forEach(op => {
      $("#comportamientoSelect").append(`<option value="${op.id}">${op.nombre}</option>`);
    });
  });
}

$("#dniPropietario").on("input", function () {
  const dni = this.value.replace(/\D/g, '');
  $(this).val(dni);
  if (dni.length === 8) {
    $.get("logica_mascotas.php", { accion: "buscar_propietario", dni }, res => {
      const data = JSON.parse(res);
      if (data.encontrado) {
        $("#mensajePropietario").hide();
        $("#tablaPropietario").show();
        $("#tablaPropietario tbody").html(`
          <tr><td>${data.apellidos} ${data.nombres}</td><td>${data.dni}</td><td>${data.barrio}</td></tr>
        `);
      } else {
        $("#tablaPropietario tbody").empty();
        $("#tablaPropietario").hide();
        $("#mensajePropietario").text("‚ö†Ô∏è No se encuentra al propietario.").show();
      }
    });
  } else {
    $("#tablaPropietario").hide();
    $("#mensajePropietario").hide();
  }
});

$("#formMascota").on("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  formData.append("accion", modoEdicion ? "editar" : "crear");

  $.ajax({
    url: "logica_mascotas.php",
    method: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      Swal.fire({
        icon: "success",
        title: "Mascota guardada",
        text: "Los datos han sido registrados correctamente.",
        showConfirmButton: false,
        timer: 1800
      }).then(() => {
        location.reload(); // recarga luego del cierre del Swal
      });
    },
    error: function () {
      Swal.fire({
        icon: "error",
        title: "Error al guardar",
        text: "No se pudo registrar la mascota. Revisa la consola o la conexi√≥n.",
      });
    }
  });
});

function toggleRegistros() {
  $("#panelRegistros").slideToggle();
  listarMascotas();
}

$("#buscarMascotas, #ordenarMascotas").on("input change", listarMascotas);

function listarMascotas() {
  $.get("logica_mascotas.php", {
    accion: "listar",
    busqueda: $("#buscarMascotas").val(),
    orden: $("#ordenarMascotas").val()
  }, html => {
    $("#tablaMascotas").html(html);
  });
}

function editarMascota(id) {
  $.get("logica_mascotas.php", { accion: "obtener", id }, res => {
    const data = JSON.parse(res);
    console.log("üì¶ Mascota cargada:", data);
    $("#idMascota").val(data.idMascota);
    console.log("üß™ ID insertado en campo oculto:", $("#idMascota").val());

    if (data.foto) {
      $("#previewImagen").attr("src", data.foto).show();
    }

    idMascotaEdicion = data.idMascota;
    modoEdicion = true;
    $("#nombreMascota").val(data.nombreMascota);
    $("#especieSelect").val(data.idEspecie);
    $("#generoSelect").val(data.idGenero);
    $("#edadMascota").val(data.edad_mascotas);
    console.log("üé® Color recibido:", data.color);
    $("#colorMascota").val(data.color || "");
    $("#comportamientoSelect").val(data.idcomportamientos);
    $("#dniPropietario").val(data.dni);
    $("#observaciones").val(data.observaciones || "");
    $("#btnGuardar").text("Guardar actualizaci√≥n");
    $("html, body").animate({ scrollTop: 0 }, "slow");

    // üü® Alerta con resumen de la mascota
    Swal.fire({
      title: `Editando mascota #${data.idMascota}`,
      html: `
        <strong>Nombre:</strong> ${data.nombreMascota}<br>
        <strong>Edad:</strong> ${data.edad_mascotas}<br>
        <strong>Color:</strong> ${data.color}<br>
        <strong>G√©nero:</strong> ${$("#generoSelect option:selected").text()}<br>
        <strong>Especie:</strong> ${$("#especieSelect option:selected").text()}<br>
        <strong>Comportamiento:</strong> ${$("#comportamientoSelect option:selected").text()}
      `,
      icon: "info",
      confirmButtonText: "Continuar",
      customClass: { popup: "swal-edicion-popup" }
    });
  });
}

function eliminarMascota(id, nombre) {
  Swal.fire({
    title: `¬øEliminar a "${nombre}"?`,
    text: "Esta acci√≥n no se puede deshacer.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "S√≠, eliminar",
    cancelButtonText: "Cancelar",
    confirmButtonColor: "#d33",
    cancelButtonColor: "#999"
  }).then(result => {
    if (result.isConfirmed) {
      $.post("logica_mascotas.php", { accion: "eliminar", id }, function () {
        listarMascotas();

        Swal.fire({
          icon: "success",
          title: "Mascota eliminada",
          text: `"${nombre}" ha sido borrada correctamente.`,
          timer: 1800,
          showConfirmButton: false
        });
      });
    }
  });
}
</script>

<script>
  let ultimoScroll = 0;
  const navbar = document.querySelector('.navbar');

  window.addEventListener('scroll', () => {
    const scrollActual = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollActual > ultimoScroll) {
      // Scroll hacia abajo ‚Üí ocultar
      navbar.style.transform = 'translate(-50%, -120%)';
    } else {
      // Scroll hacia arriba ‚Üí mostrar
      navbar.style.transform = 'translate(-50%, 0)';
    }

    ultimoScroll = scrollActual <= 0 ? 0 : scrollActual; // evitar valores negativos
  });
  </script>

</body>
</html>

