<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Medicamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
body {
  margin: 0;
  font-family: sans-serif;
}

.background {
  padding-top: 120px;
  position: relative;
}

.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  max-width: 1000px;  /* ← CAMBIA ESTE VALOR PARA HACER EL FORM MÁS ANCHO */
  margin: auto;
  padding: 40px;
}

.boton-atras {
      display: inline-block;
      margin: 80px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
      top: 10px;
  left: 10px;
  z-index: 999;
  position: absolute;
    }

.boton-atras:hover {
  background-color: #0056b3;
}

/* Navbar */
.navbar {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.6);
  z-index: 1000;
  border-radius: 30px;
  padding: 12px 30px;
  width: 95%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: sans-serif;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

.navbar-title {
  font-weight: bold;
  font-size: 1.2rem;
  color: #000;
}

.navbar-links {
  display: flex;
  gap: 25px;
}

.navbar-links a {
  text-decoration: none;
  color: #007bff;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 20px;
  transition: all 0.3s ease;
}

.navbar-links a:hover,
.navbar-links a.active {
  background-color: #007bff;
  color: white;
}

.hidden {
  display: none;
}

h2 {
  margin-bottom: 30px;
  text-align: center;
}

form {
  display: grid;
  gap: 20px;
}

label {
  font-weight: bold;
}

input[type="text"],
textarea,
input[type="date"],
select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #f9f9f9;
}

textarea {
  resize: vertical;
}

.boton {
  padding: 12px;
  background-color: #007bff;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.boton:hover {
  background-color: #0056b3;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

table, th, td {
  border: 1px solid #ccc;
}

th, td {
  padding: 10px;
  text-align: center;
}

th {
  background-color: #007bff;
  color: white;
  cursor: pointer;
}

.radio-group {
  display: flex;
  justify-content: space-around;
  gap: 20px;
  margin: 10px 0;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
}

.btn-accion {
  padding: 6px 10px;
  margin: 2px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

.btn-editar {
  background-color: #28a745;
  color: white;
}

.btn-eliminar {
  background-color: #dc3545;
  color: white;
}

.arrow {
  font-size: 0.8em;
  margin-left: 5px;
}

  </style>
</head>
<body>

  <header class="navbar">
    <div class="navbar-title">Municipalidad de Huaraz</div>
    <nav class="navbar-links">
      <a href="registro_personas.html">Registrar Propietario o Veterinario</a>
      <a href="registro_mascotas.html">Registro de Mascotas</a>
      <a href="interfaz_campaña.html">Registro/creación de Campañas</a>
      <a href="registro_medicamentos.html" class="active">Registro de Medicamentos</a>
    </nav>
  </header>

  <div class="background">
    <a href="main_menu.html" class="boton-atras">← Atrás</a>

    <div class="container">
      <img src="imagenes/logo2muni.png" alt="Logo" style="width:450px; height:auto; margin: 0 auto 20px; display: block;" />
      <h2>Registro de Medicamentos</h2>

      <form id="formMedicamento">
        <div>
          <label for="nom_medicina">Nombre del medicamento</label>
          <input type="text" id="nom_medicina" name="nom_medicina" required>
        </div>

        <div>
          <label for="descripcion">Descripción</label>
          <textarea id="descripcion" name="descripcion" rows="3" required></textarea>
        </div>

        <div>
          <label for="fec_vencimiento">Fecha de vencimiento</label>
          <input type="date" id="fec_vencimiento" name="fec_vencimiento" required>
        </div>

        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="tipo_lote" value="nuevo" checked />
            <span>Crear nuevo lote</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="tipo_lote" value="registrado" />
            <span>Lote registrado</span>
          </label>
        </div>

        <div id="nuevoLoteDiv">
          <label for="nuevo_lote">Código del nuevo lote</label>
          <input type="text" id="nuevo_lote" name="nuevo_lote" placeholder="Ej: LOTE-2025A" />
        </div>

        <div id="loteRegistradoDiv" style="display:none;">
          <label for="idlotes">Lotes existentes</label>
          <select id="idlotes" name="idlotes">
            <option value="">Seleccione un lote</option>
          </select>
        </div>

        <button type="submit" class="boton">Guardar</button>
        <button type="button" class="boton" onclick="verRegistros()">Ver Registros Recientes</button>
      </form>

      <input type="text" id="buscador" placeholder="Buscar por ID, Nombre, Descripción, Vencimiento o Lote" style="display:none; width: 100%; padding: 10px; margin-top: 20px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc;">

      <div id="tablaRegistros" style="display: none;"></div>
    </div>
  </div>

  <script>
    let idEditar = null;
    let datosOriginales = [];

    function cargarLotes() {
      fetch('obtener_lotes.php')
        .then(response => response.json())
        .then(data => {
          const loteSelect = document.getElementById('idlotes');
          loteSelect.innerHTML = '<option value="">Seleccione un lote</option>';
          data.forEach(lote => {
            const option = document.createElement('option');
            option.value = lote.idlotes;
            option.textContent = lote.codigos_lotes;
            loteSelect.appendChild(option);
          });
        });
    }

    function verRegistros() {
  const panel = document.getElementById("tablaRegistros");
  const buscador = document.getElementById("buscador");

  // Toggle estilo de visibilidad
  const visible = panel.style.display === "block";

  if (visible) {
    panel.style.display = "none";
    buscador.style.display = "none";
  } else {
    fetch('listar_medicamentos.php')
      .then(response => response.json())
      .then(data => {
        datosOriginales = data;
        renderizarTabla(datosOriginales);
        panel.style.display = "block";
        buscador.style.display = "block";
      });
  }
}

    function renderizarTabla(data) {
      let tabla = `
        <table id="tablaMedicamentos">
          <thead>
            <tr>
              <th onclick="ordenarTabla(0, this)">ID <span class="arrow"></span></th>
              <th onclick="ordenarTabla(1, this)">Nombre <span class="arrow"></span></th>
              <th onclick="ordenarTabla(2, this)">Descripción <span class="arrow"></span></th>
              <th onclick="ordenarTabla(3, this)">Vencimiento <span class="arrow"></span></th>
              <th onclick="ordenarTabla(4, this)">Lote <span class="arrow"></span></th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(item => {
        tabla += `
          <tr>
            <td>${item.idmedicinas}</td>
            <td>${item.nom_medicina}</td>
            <td>${item.descripcion}</td>
            <td>${item.fec_vencimiento}</td>
            <td>${item.codigos_lotes}</td>
            <td>
              <button class="btn-accion btn-editar" onclick="editarMedicamento(${item.idmedicinas})">Editar</button>
              <button class="btn-accion btn-eliminar" onclick="eliminarMedicamento(${item.idmedicinas})">Eliminar</button>
            </td>
          </tr>
        `;
      });

      tabla += '</tbody></table>';
      document.getElementById('tablaRegistros').innerHTML = tabla;
    }

    function ordenarTabla(columna, thElement) {
      const tabla = document.getElementById("tablaMedicamentos");
      const tbody = tabla.tBodies[0];
      const filas = Array.from(tbody.rows);
      const ascendente = !tabla.getAttribute("data-asc") || tabla.getAttribute("data-asc") === "false";

      filas.sort((a, b) => {
        const textoA = a.cells[columna].innerText.trim().toLowerCase();
        const textoB = b.cells[columna].innerText.trim().toLowerCase();
        return ascendente ? textoA.localeCompare(textoB) : textoB.localeCompare(textoA);
      });

      filas.forEach(fila => tbody.appendChild(fila));
      tabla.setAttribute("data-asc", ascendente);

      document.querySelectorAll("th .arrow").forEach(span => span.textContent = "");
      thElement.querySelector(".arrow").textContent = ascendente ? "↑" : "↓";
    }

    document.getElementById('buscador').addEventListener('input', function () {
      const texto = this.value.toLowerCase();
      const filtrado = datosOriginales.filter(item =>
        Object.values(item).some(val => String(val).toLowerCase().includes(texto))
      );
      renderizarTabla(filtrado);
    });

    function eliminarMedicamento(id) {
      Swal.fire({
        title: '¿Estás seguro?',
        text: "No podrás revertir esto!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch('eliminar_medicamento.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + id
          })
          .then(res => res.text())
          .then(response => {
            Swal.fire('Eliminado', response, 'success');
            verRegistros();
          });
        }
      });
    }

    function editarMedicamento(id) {
      fetch(`obtener_medicamento.php?id=${id}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('nom_medicina').value = data.nom_medicina;
          document.getElementById('descripcion').value = data.descripcion;
          document.getElementById('fec_vencimiento').value = data.fec_vencimiento;

          const radios = document.getElementsByName('tipo_lote');
          radios.forEach(radio => {
            if (radio.value === 'registrado') radio.checked = true;
          });

          document.getElementById('nuevoLoteDiv').style.display = 'none';
          document.getElementById('loteRegistradoDiv').style.display = 'block';
          document.getElementById('idlotes').value = data.idlotes;

          idEditar = id;
          document.querySelector('button[type="submit"]').textContent = 'Actualizar';
        });
    }

    document.querySelectorAll('input[name="tipo_lote"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const tipo = this.value;
        document.getElementById('nuevoLoteDiv').style.display = tipo === 'nuevo' ? 'block' : 'none';
        document.getElementById('loteRegistradoDiv').style.display = tipo === 'registrado' ? 'block' : 'none';
      });
    });

    document.getElementById('formMedicamento').addEventListener('submit', function (e) {
      e.preventDefault();
      const tipo = document.querySelector('input[name="tipo_lote"]:checked').value;
      const formData = new FormData(this);
      formData.append("tipo_lote", tipo);

      if (tipo === "registrado") {
        const loteSeleccionado = document.getElementById("idlotes").value;
        formData.set("idlotes", loteSeleccionado);
      } else {
        const nuevoLote = document.getElementById("nuevo_lote").value;
        formData.set("nuevo_lote", nuevoLote);
      }

      if (idEditar) {
        formData.append("idmedicinas", idEditar);
      }

      const url = idEditar ? 'actualizar_medicamento.php' : 'guardar_medicamento.php';

      fetch(url, {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(response => {
        Swal.fire({
          icon: "success",
          title: idEditar ? "¡Actualizado!" : "¡Registrado!",
          text: response,
          confirmButtonColor: "#007bff"
        });
        this.reset();
        cargarLotes();
        verRegistros();
        idEditar = null;
        document.querySelector('button[type="submit"]').textContent = 'Guardar';
      })
      .catch(error => {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "No se pudo registrar o actualizar.",
          confirmButtonColor: "#dc3545"
        });
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      cargarLotes();
      verRegistros();
    });
  </script>
<script>
  let ultimoScroll = 0;
  const navbar = document.querySelector('.navbar');

  window.addEventListener('scroll', () => {
    const scrollActual = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollActual > ultimoScroll) {
      // Scroll hacia abajo → ocultar
      navbar.style.transform = 'translate(-50%, -120%)';
    } else {
      // Scroll hacia arriba → mostrar
      navbar.style.transform = 'translate(-50%, 0)';
    }

    ultimoScroll = scrollActual <= 0 ? 0 : scrollActual; // evitar valores negativos
  });
  </script>

</body>
</html>